<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mabuya Trading Dashboard - Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos Personalizados y Variables */
        :root {
            --accent-color: #3b82f6; /* Tailwind blue-500 */
        }
        .accent-color { color: var(--accent-color); }
        .accent-bg { background-color: var(--accent-color); }
        .accent-border-color { border-color: var(--accent-color); }
        
        .card { background-color: #ffffff; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        
        /* L贸gica de Pesta帽as */
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .tab-button { padding: 0.75rem 1.5rem; border-radius: 0.5rem 0.5rem 0 0; cursor: pointer; color: #6b7280; font-weight: 500; transition: color 0.2s, border-color 0.2s; border-bottom: 2px solid transparent; }
        .tab-button.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .panel-inner { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem; }
        .panel-title { font-size: 1.875rem; font-weight: 700; margin-bottom: 1rem; }
        .panel-lead { color: #6b7280; margin-bottom: 2rem; font-size: 1rem; }
        
        /* Spinner de carga para Noticias IA */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="custom-alert" class="fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-transform duration-300 transform translate-x-full text-sm" role="alert">
        Mensaje de prueba
    </div>

    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4 md:justify-start md:space-x-10">
                <div class="flex justify-start lg:w-0 lg:flex-1">
                    <h1 class="text-xl font-bold accent-color">Mabuya Trading</h1> 
                </div>
                <nav class="flex space-x-4">
                    <button class="tab-button active" data-tab="inicio">Dashboard</button>
                    <button class="tab-button" data-tab="calculadoras">Calculadoras</button>
                    <button class="tab-button" data-tab="noticias-ia">Noticias IA</button>
                    <button class="tab-button" data-tab="videos">Videos</button>
                    <button class="tab-button" data-tab="academia">Academia</button>
                    <button class="tab-button" data-tab="eventos">Eventos Clave</button>
                </nav>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-6 pb-12">
        
        <div id="inicio" class="tab-panel active">
            <div class="panel-inner">
                <h1 class="panel-title accent-color">Dashboard Principal</h1>
                <p class="panel-lead">
                    Bienvenido. Monitorea el par <span id="current-ticker" class="font-bold text-lg text-blue-600">FX_IDC:EURUSD</span> en tiempo real y gestiona tus herramientas clave.
                </p>

                <div class="mb-6 flex flex-col sm:flex-row gap-3">
                    <input type="text" id="ticker-input" placeholder="Ej: NASDAQ:TSLA" class="flex-grow p-3 rounded bg-white border border-gray-300 text-gray-800 focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <button onclick="updateTicker()" class="w-full sm:w-auto px-6 py-3 accent-bg hover:bg-blue-600 text-white font-semibold rounded-md transition duration-200 flex items-center justify-center text-sm">
                        Actualizar Gr谩fico
                    </button>
                </div>

                <div id="chart-widget-container" class="h-[500px] w-full card p-1 mb-10">
                    </div>
            </div>
        </div>
        <div id="calculadoras" class="tab-panel">
            <div class="panel-inner grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card p-6 border-l-4 border-green-500">
                    <h2 class="card-title text-green-600 mb-4">Calculadora de Precio Objetivo (Take Profit)</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="compraPrice" class="block text-sm font-medium text-gray-700">Precio de Compra (Entry Price)</label>
                            <input type="number" step="0.01" id="compraPrice" value="100.00" oninput="actualizarCalculadoras()" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div>
                            <label for="profitPercent" class="block text-sm font-medium text-gray-700">Porcentaje de Ganancia Deseado (%)</label>
                            <input type="number" step="0.1" id="profitPercent" value="3.5" oninput="actualizarCalculadoras()" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div class="pt-4 border-t border-gray-200">
                            <label for="minSellPrice" class="block text-sm font-medium text-green-600">Precio M铆nimo de Venta (Take Profit)</label>
                            <input type="text" id="minSellPrice" readonly class="mt-1 block w-full p-2 bg-green-50 border border-green-300 rounded-md shadow-sm font-bold text-lg text-green-800" value="103.50">
                        </div>
                    </div>
                </div>

                <div class="card p-6 border-l-4 border-yellow-500">
                    <h2 class="card-title text-yellow-600 mb-4">Calculadora de Posici贸n Promedio (DCA)</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-4 gap-2 text-xs font-semibold text-gray-500 border-b pb-2">
                            <span>Posici贸n</span>
                            <span>Precio</span>
                            <span>Cantidad</span>
                            <span class="text-right">Total ($)</span>
                        </div>
                        
                        <div class="grid grid-cols-4 gap-2 items-center">
                            <span class="text-sm font-medium">Compra 1</span>
                            <input type="number" step="0.01" id="price1" value="10.00" oninput="actualizarCalculadoras()" class="p-2 border border-gray-300 rounded-md text-sm">
                            <input type="number" step="1" id="quantity1" value="10" oninput="actualizarCalculadoras()" class="p-2 border border-gray-300 rounded-md text-sm">
                            <span id="total1" class="text-right font-medium">100.00</span>
                        </div>

                        <div class="grid grid-cols-4 gap-2 items-center">
                            <span class="text-sm font-medium">Compra 2</span>
                            <input type="number" step="0.01" id="price2" value="9.50" oninput="actualizarCalculadoras()" class="p-2 border border-gray-300 rounded-md text-sm">
                            <input type="number" step="1" id="quantity2" value="5" oninput="actualizarCalculadoras()" class="p-2 border border-gray-300 rounded-md text-sm">
                            <span id="total2" class="text-right font-medium">47.50</span>
                        </div>
                        
                        <div class="grid grid-cols-4 gap-2 items-center">
                            <span class="text-sm font-medium">Compra 3</span>
                            <input type="number" step="0.01" id="price3" value="0" oninput="actualizarCalculadoras()" class="p-2 border border-gray-300 rounded-md text-sm">
                            <input type="number" step="1" id="quantity3" value="0" oninput="actualizarCalculadoras()" class="p-2 border border-gray-300 rounded-md text-sm">
                            <span id="total3" class="text-right font-medium">0.00</span>
                        </div>

                        <div class="pt-4 border-t border-gray-200 space-y-2">
                            <div class="flex justify-between font-semibold text-gray-800">
                                <span>Total Cantidad:</span>
                                <span id="totalQuantity" class="text-yellow-700">15</span>
                            </div>
                            <div class="flex justify-between font-semibold text-gray-800">
                                <span>Inversi贸n Total ($):</span>
                                <span id="totalInvestment" class="text-yellow-700">147.50</span>
                            </div>
                            <div class="flex justify-between font-bold text-lg text-gray-900">
                                <span>Precio Promedio:</span>
                                <span id="averagePrice" class="text-yellow-600">9.8333</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        ```

***

## 2. Parte 2: Noticias IA, Videos (Corregido), Academia y JavaScript

Esta secci贸n contiene las pesta帽as restantes, la nueva pesta帽a **Academia** y la l贸gica JavaScript completa.

```html
        <div id="noticias-ia" class="tab-panel">
            <div class="panel-inner">
                <h1 class="panel-title accent-color">Noticias IA: Sinopsis de Mercado con Google Search</h1>
                <p class="panel-lead">
                    Obt茅n un resumen de noticias de alto impacto en tiempo real. La sinopsis est谩 formateada con p谩rrafos separados por espacios.
                </p>

                <div class="mb-6 flex flex-col sm:flex-row gap-3">
                    <input type="text" id="news-query-input" placeholder="Ej: Impacto de la inflaci贸n en el oro (XAUUSD)" class="flex-grow p-3 rounded bg-white border border-gray-300 text-gray-800 focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <button id="news-search-button" onclick="handleNewsSearch()" class="w-full sm:w-auto px-6 py-3 accent-bg hover:bg-blue-600 text-white font-semibold rounded-md transition duration-200 flex items-center justify-center text-sm">
                        Buscar Noticias
                    </button>
                </div>
                
                <div id="news-loading-indicator" class="hidden flex items-center justify-center p-8 bg-gray-50 rounded-lg">
                    <div class="loading-spinner mr-3"></div>
                    <span class="text-sm sm:text-lg text-gray-500">Analizando el mercado global... (Esto puede tardar unos segundos)</span>
                </div>

                <div id="ai-news-results" class="card p-6 min-h-[150px] border-l-4 accent-border-color text-sm">
                    <p class="text-gray-500 italic">Introduce un tema de trading o macroeconom铆a para generar una sinopsis.</p>
                </div>
            </div>
        </div>
        <div id="videos" class="tab-panel">
            <div class="panel-inner">
                <h1 class="panel-title accent-color">Biblioteca de Videos Tutoriales</h1>
                <p class="panel-lead">
                    Acceso a grabaciones de sesiones en vivo y tutoriales sobre el uso de la plataforma y el an谩lisis t茅cnico avanzado de tu canal de YouTube.
                </p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="card p-0 overflow-hidden shadow-lg hover:shadow-xl transition duration-300">
                        <a href="http://www.youtube.com/watch?v=DItBSzwdH1w" target="_blank" class="block">
                            <div class="h-36 bg-gray-200 flex items-center justify-center relative">
                                <img src="https://placehold.co/300x180/ef4444/ffffff?text=SMART+MONEY+CONCEPTS" alt="Miniatura de video SMC" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center">
                                    <svg class="w-10 h-10 text-white fill-current" viewBox="0 0 24 24"><path d="M6 3l12 9-12 9V3z"/></svg>
                                </div>
                            </div>
                            <div class="p-4">
                                <h3 class="font-semibold text-base text-gray-800 hover:text-blue-600 transition duration-150">COMO ANALIZAR DE FORMA CORRECTA DESDE CERO UN GRFICO EN 5 PASOS USANDO SMART MONEY CONCEPTS</h3>
                                <p class="text-xs text-gray-500 mt-1">Duraci贸n: 1h 29m | Canal: It's Smart Money</p>
                            </div>
                        </a>
                    </div>
                    
                    <div class="card p-0 overflow-hidden shadow-lg hover:shadow-xl transition duration-300">
                        <a href="https://www.youtube.com/watch?v=tutorial-backtesting" target="_blank" class="block">
                            <div class="h-36 bg-gray-200 flex items-center justify-center relative">
                                <img src="https://placehold.co/300x180/f59e0b/ffffff?text=BACKTESTING+GUIA" alt="Miniatura de video 2" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center">
                                    <svg class="w-10 h-10 text-white fill-current" viewBox="0 0 24 24"><path d="M6 3l12 9-12 9V3z"/></svg>
                                </div>
                            </div>
                            <div class="p-4">
                                <h3 class="font-semibold text-base text-gray-800 hover:text-blue-600 transition duration-150">Gu铆a Definitiva de Backtesting Efectivo</h3>
                                <p class="text-xs text-gray-500 mt-1">Duraci贸n: 45 min | Publicado: Hace 1 semana</p>
                            </div>
                        </a>
                    </div>
                    
                    <div class="card p-0 overflow-hidden shadow-lg hover:shadow-xl transition duration-300">
                        <a href="https://www.youtube.com/watch?v=tutorial-psicologia" target="_blank" class="block">
                            <div class="h-36 bg-gray-200 flex items-center justify-center relative">
                                <img src="https://placehold.co/300x180/10b981/ffffff?text=PSICOLOGIA+TRADING" alt="Miniatura de video 3" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center">
                                    <svg class="w-10 h-10 text-white fill-current" viewBox="0 0 24 24"><path d="M6 3l12 9-12 9V3z"/></svg>
                                </div>
                            </div>
                            <div class="p-4">
                                <h3 class="font-semibold text-base text-gray-800 hover:text-blue-600 transition duration-150">La Psicolog铆a Detr谩s de la P茅rdida y el Miedo</h3>
                                <p class="text-xs text-gray-500 mt-1">Duraci贸n: 15 min | Publicado: Hace 2 semanas</p>
                            </div>
                        </a>
                    </div>

                    <div class="card p-0 overflow-hidden shadow-lg hover:shadow-xl transition duration-300">
                        <a href="https://www.youtube.com/watch?v=tutorial-gestion-riesgo" target="_blank" class="block">
                            <div class="h-36 bg-gray-200 flex items-center justify-center relative">
                                <img src="https://placehold.co/300x180/3b82f6/ffffff?text=RIESGO+Y+LOTE" alt="Miniatura de video 4" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center">
                                    <svg class="w-10 h-10 text-white fill-current" viewBox="0 0 24 24"><path d="M6 3l12 9-12 9V3z"/></svg>
                                </div>
                            </div>
                            <div class="p-4">
                                <h3 class="font-semibold text-base text-gray-800 hover:text-blue-600 transition duration-150">C谩lculo Preciso de Lote y Stop Loss Din谩mico</h3>
                                <p class="text-xs text-gray-500 mt-1">Duraci贸n: 30 min | Publicado: Hace 1 mes</p>
                            </div>
                        </a>
                    </div>

                </div>
            </div>
        </div>
        <div id="academia" class="tab-panel">
            <div class="panel-inner">
                <h1 class="panel-title" style="color: #10b981;"> Academia: Ruta de Aprendizaje Completa</h1>
                <p class="panel-lead">
                    Sigue un camino estructurado desde lo b谩sico hasta el an谩lisis avanzado. Marca tu progreso en cada m贸dulo.
                </p>

                <div class="space-y-8">
                    
                    <div class="card p-6 border-l-4 border-gray-400">
                        <h2 class="text-xl font-bold text-gray-700 mb-3 flex items-center">
                            <span class="bg-gray-400 text-white px-3 py-1 rounded-full mr-3 text-sm">M1</span>
                            Fundamentos Esenciales del Trading
                        </h2>
                        <ul class="space-y-2">
                            <li class="flex items-center text-sm text-gray-600">
                                <input type="checkbox" id="m1l1" class="form-checkbox text-blue-500 rounded mr-2"><label for="m1l1">Introducci贸n: 驴Qu茅 es el Trading y el Mercado?</label>
                            </li>
                            <li class="flex items-center text-sm text-gray-600">
                                <input type="checkbox" id="m1l2" class="form-checkbox text-blue-500 rounded mr-2"><label for="m1l2">Tipos de An谩lisis: T茅cnico vs. Fundamental</label>
                            </li>
                            <li class="flex items-center text-sm text-gray-600">
                                <input type="checkbox" id="m1l3" class="form-checkbox text-blue-500 rounded mr-2"><label for="m1l3">El Poder de las Velas Japonesas</label>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="card p-6 border-l-4 border-blue-500">
                        <h2 class="text-xl font-bold text-blue-700 mb-3 flex items-center">
                            <span class="bg-blue-500 text-white px-3 py-1 rounded-full mr-3 text-sm">M2</span>
                            An谩lisis T茅cnico Avanzado (SMC)
                        </h2>
                        <ul class="space-y-2">
                            <li class="flex items-center text-sm text-gray-600">
                                <input type="checkbox" id="m2l1" class="form-checkbox text-blue-500 rounded mr-2"><label for="m2l1">Estructura de Mercado (Market Structure)</label>
                            </li>
                            <li class="flex items-center text-sm text-gray-600">
                                <input type="checkbox" id="m2l2" class="form-checkbox text-blue-500 rounded mr-2"><label for="m2l2">Bloques de rdenes (Order Blocks) y Breakers</label>
                            </li>
                            <li class="flex items-center text-sm text-gray-600">
                                <input type="checkbox" id="m2l3" class="form-checkbox text-blue-500 rounded mr-2"><label for="m2l3">Liquidez, Inducement y Desequilibrios (FVG)</label>
                            </li>
                        </ul>
                    </div>

                    <div class="card p-6 border-l-4 border-yellow-500">
                        <h2 class="text-xl font-bold text-yellow-700 mb-3 flex items-center">
                            <span class="bg-yellow-500 text-white px-3 py-1 rounded-full mr-3 text-sm">M3</span>
                            Gesti贸n de Capital y Psicolog铆a
                        </h2>
                        <ul class="space-y-2">
                            <li class="flex items-center text-sm text-gray-600">
                                <input type="checkbox" id="m3l1" class="form-checkbox text-blue-500 rounded mr-2"><label for="m3l1">Reglas de Posici贸n: Lote, Stop Loss y TP</label>
                            </li>
                            <li class="flex items-center text-sm text-gray-600">
                                <input type="checkbox" id="m3l2" class="form-checkbox text-blue-500 rounded mr-2"><label for="m3l2">Diario de Trading y Backtesting</label>
                            </li>
                            <li class="flex items-center text-sm text-gray-600">
                                <input type="checkbox" id="m3l3" class="form-checkbox text-blue-500 rounded mr-2"><label for="m3l3">Control Emocional: Miedo y Avaricia</label>
                            </li>
                        </ul>
                    </div>

                </div>
            </div>
        </div>
        <div id="eventos" class="tab-panel">
            <div class="panel-inner">
                <h1 class="panel-title" style="color: #f59e0b;">Calendario de Eventos Clave</h1>
                <p class="panel-lead">
                    Mantente al d铆a con los anuncios econ贸micos de alto impacto que mueven el mercado (Noticias de "Alto Impacto").
                </p>
                
                <div class="card p-6 border-l-4 border-red-500">
                    <h2 class="card-title text-red-500">Pr贸ximos Anuncios Relevantes</h2>
                    <ul class="space-y-3 text-sm">
                        <li class="flex items-center">
                            <span class="text-xs font-semibold bg-red-600 px-2 py-1 rounded mr-3 text-white">3x</span>
                            <span>**IPC (ndice de Precios al Consumidor) - US:**  10 de Diciembre, 8:30 AM EST.</span>
                        </li>
                        <li class="flex items-center">
                            <span class="text-xs font-semibold bg-red-600 px-2 py-1 rounded mr-3 text-white">3x</span>
                            <span>**Decisi贸n de Tasa de Inter茅s (FED):**  18 de Diciembre, 2:00 PM EST.</span>
                        </li>
                        <li class="flex items-center">
                            <span class="text-xs font-semibold bg-orange-500 px-2 py-1 rounded mr-3 text-white">2x</span>
                            <span>**PMI Manufacturero:**  2 de Enero, 9:45 AM EST.</span>
                        </li>
                        <li class="flex items-center">
                            <span class="text-xs font-semibold bg-orange-500 px-2 py-1 rounded mr-3 text-white">2x</span>
                            <span>**N贸minas no Agr铆colas (NFP):**  5 de Enero, 8:30 AM EST.</span>
                        </li>
                    </ul>
                    <p class="mt-4 text-xs text-gray-500">
                        Nota: Los eventos 3x (rojo) generan la mayor volatilidad. Evita operar 30 minutos antes y despu茅s de su publicaci贸n.
                    </p>
                </div>
            </div>
        </div>
        </main>

    <script>
        // --- L贸gica de Utilidad ---
        function alertMessage(message, type = 'info') {
            const alertBox = document.getElementById('custom-alert');
            alertBox.textContent = message;
            alertBox.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-transform duration-300 transform translate-x-0';

            if (type === 'success') {
                alertBox.classList.add('bg-green-600', 'text-white');
            } else if (type === 'error') {
                alertBox.classList.add('bg-red-600', 'text-white');
            } else {
                alertBox.classList.add('bg-blue-600', 'text-white');
            }

            // Ocultar despu茅s de 5 segundos
            setTimeout(() => {
                alertBox.classList.add('translate-x-full');
            }, 5000);
            alertBox.classList.remove('translate-x-full');
        }

        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                    if (response.status === 429 && i < retries - 1) { // Too Many Requests
                        await new Promise(resolve => setTimeout(resolve, delay * (2 ** i)));
                        continue;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay * (2 ** i)));
                }
            }
        }

        // --- L贸gica de la Pesta帽a INICIO (Gr谩fico TradingView) ---

        window.loadTradingViewWidget = function(symbol) {
            const container = document.getElementById('chart-widget-container');
            container.innerHTML = ''; // Limpiar el widget anterior
            
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
            script.async = true;
            
            script.innerHTML = JSON.stringify({
                "symbol": symbol,
                "interval": "60",
                "timezone": "America/New_York",
                "theme": "light",
                "style": "1",
                "locale": "es",
                "enable_publishing": false,
                "allow_symbol_change": true,
                "save_image": false,
                "details": true,
                "withdateranges": true,
                "studies": ["RSI@tv-basic"],
                "show_popup_button": true,
                "popup_width": "100%", // Ajuste para responsive
                "popup_height": "100%", // Ajuste para responsive
                "support_host": "https://www.tradingview.com"
            });
            
            container.appendChild(script);
        };

        window.updateTicker = function() {
            const input = document.getElementById('ticker-input');
            const currentTickerSpan = document.getElementById('current-ticker');
            const newTicker = input.value.trim().toUpperCase();

            if (newTicker) {
                currentTickerSpan.textContent = newTicker;
                window.loadTradingViewWidget(newTicker);
                alertMessage(`Cargando gr谩fico para ${newTicker}...`, 'success');
            } else {
                alertMessage("Por favor, introduce un s铆mbolo de activo v谩lido.", 'error');
            }
        }

        // --- L贸gica de Calculadoras (Combinadas) ---

        /**
         * Funci贸n que llama a las dos calculadoras para actualizar todos los resultados.
         */
        window.actualizarCalculadoras = function() {
            calcularPrecioObjetivo();
            calcularPosicionPromedio();
        }

        /**
         * Calcula el precio de Venta sumando el valor de Compra m谩s el margen
         * calculado por el Porcentaje. (Calculadora 1: Precio Objetivo)
         */
        function calcularPrecioObjetivo() {
            const compraPriceInput = document.getElementById('compraPrice');
            const profitPercentInput = document.getElementById('profitPercent');
            const minSellPriceOutput = document.getElementById('minSellPrice');

            const compraPrice = parseFloat(compraPriceInput.value) || 0;
            const profitPercent = parseFloat(profitPercentInput.value) || 0;

            const margen = (compraPrice * profitPercent) / 100;
            const venta = compraPrice + margen;

            if (isNaN(venta) || venta < 0) {
                minSellPriceOutput.value = "0.00";
            } else {
                minSellPriceOutput.value = venta.toFixed(2);
            }
        }

        /**
         * Calcula el precio promedio de la posici贸n de compra (Calculadora 2: Posici贸n Promedio)
         */
        function calcularPosicionPromedio() {
            let totalQuantity = 0;
            let totalInvestment = 0;

            // Iterar sobre las 3 posibles posiciones (Compra 1, 2, 3)
            for (let i = 1; i <= 3; i++) {
                const priceInput = document.getElementById(`price${i}`);
                const quantityInput = document.getElementById(`quantity${i}`);
                const totalDisplay = document.getElementById(`total${i}`);

                const price = parseFloat(priceInput.value) || 0;
                const quantity = parseFloat(quantityInput.value) || 0;
                const total = price * quantity;

                // Actualizar total individual y acumular globales
                totalDisplay.textContent = total.toFixed(2);
                
                totalQuantity += quantity;
                totalInvestment += total;
            }

            let averagePrice = 0;
            if (totalQuantity > 0) {
                averagePrice = totalInvestment / totalQuantity;
            }

            // Actualizar resultados globales
            document.getElementById('totalQuantity').textContent = totalQuantity.toFixed(0);
            document.getElementById('totalInvestment').textContent = totalInvestment.toFixed(2);
            document.getElementById('averagePrice').textContent = averagePrice.toFixed(4); // Usar 4 decimales para mayor precisi贸n
        }

        // --- L贸gica de Noticias IA (Gemini API) ---

        window.handleNewsSearch = function() {
            const queryText = document.getElementById('news-query-input').value.trim();
            fetchFilteredNews(queryText);
        }

        async function fetchFilteredNews(queryText) {
            // Reemplaza esto con tu clave API real.
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const searchButton = document.getElementById('news-search-button');
            const newsContainer = document.getElementById('ai-news-results');
            const loadingIndicator = document.getElementById('news-loading-indicator');

            if (!queryText) {
                alertMessage("Por favor, introduce un tema de b煤squeda.", 'error');
                return;
            }
            if (!apiKey) {
                newsContainer.innerHTML = '<p class="text-red-500">Error: La clave API est谩 vac铆a. Por favor, introduce tu clave en el c贸digo JavaScript.</p>';
                alertMessage("Clave API Faltante.", 'error');
                return;
            }


            loadingIndicator.classList.remove('hidden');
            searchButton.disabled = true;
            newsContainer.innerHTML = '';
            
            const systemPrompt = `Eres un analista de mercado financiero de 茅lite. Proporciona una sinopsis concisa y profesional de las 煤ltimas noticias sobre el tema solicitado. Tu respuesta DEBE ESTAR FORMATEADA usando saltos de l铆nea doble (\n\n) entre p谩rrafos completos para asegurar una lectura fluida en el navegador. No uses encabezados ni listas. Solo texto continuo separado por p谩rrafos vac铆os.`;

            const userQuery = `Busca y resume la situaci贸n actual y las noticias clave sobre: ${queryText}. Ensure the response is in Spanish.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;

                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                    
                    // Renderizar el resultado. 'whitespace-pre-wrap' es CLAVE para respetar los \n\n
                    let newsHtml = `
                        <h3 class="card-title text-gray-800 mb-4 text-base sm:text-lg">Sinopsis para: ${queryText}</h3>
                        <p class="text-gray-600 whitespace-pre-wrap text-sm">${text}</p>
                    `;
                    
                    if (sources.length > 0) {
                        newsHtml += '<div class="mt-6 pt-4 border-t border-gray-200">';
                        newsHtml += '<h4 class="text-xs font-semibold text-gray-500 mb-2">Fuentes Citadas:</h4>';
                        sources.forEach(source => {
                            newsHtml += `<a href="${source.uri}" target="_blank" class="block text-xs accent-color hover:underline">${source.title}</a>`;
                        });
                        newsHtml += '</div>';
                    }
                    
                    newsContainer.innerHTML = newsHtml;
                    alertMessage("Noticia generada con 茅xito.", 'success');

                } else {
                    newsContainer.innerHTML = '<p class="text-red-500">No se pudo generar la sinopsis. Int茅ntalo de nuevo o prueba una consulta diferente.</p>';
                    alertMessage("Error en la respuesta del modelo.", 'error');
                }

            } catch (error) {
                console.error("API Call Error:", error);
                newsContainer.innerHTML = `<p class="text-red-500">Error al contactar al servicio de noticias: ${error.message}</p>`;
                alertMessage(`Error de red o API: ${error.message}`, 'error');
            } finally {
                loadingIndicator.classList.add('hidden');
                searchButton.disabled = false;
            }
        }


        // --- L贸gica General de Pesta帽as y Arranque ---

        document.addEventListener('DOMContentLoaded', () => {
            const tabs = document.querySelectorAll('.tab-button');
            const panels = document.querySelectorAll('.tab-panel');

            function activateTab(tabId) {
                tabs.forEach(tab => tab.classList.remove('active'));
                panels.forEach(panel => panel.classList.remove('active'));

                const activeTabButton = document.querySelector(`[data-tab="${tabId}"]`);
                const activePanel = document.getElementById(tabId);
                
                if (activeTabButton) activeTabButton.classList.add('active');
                if (activePanel) activePanel.classList.add('active');

                // Si la pesta帽a es 'inicio' o 'calculadoras', forzar la actualizaci贸n
                if (tabId === 'inicio' || tabId === 'calculadoras') {
                    // Solo es necesario ejecutar la funci贸n si la funci贸n existe.
                    if (window.actualizarCalculadoras) {
                        actualizarCalculadoras(); 
                    }
                }
            }

            tabs.forEach(tab => {
                tab.addEventListener('click', (event) => {
                    const tabId = event.target.getAttribute('data-tab');
                    activateTab(tabId);
                });
            });

            // Cargar el widget de TradingView por defecto al inicio
            window.loadTradingViewWidget('FX_IDC:EURUSD');

            // Activar la pesta帽a inicial ("inicio") al cargar y configurar listeners
            activateTab('inicio');
        });
    </script>
</body>
</html>